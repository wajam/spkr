<!doctype html>
<html>
	<head>
		<meta charset="utf-8" />
		<style>
			h1,h2,h3,h4 {text-align:center;}
		</style>
		<title>SPK social platform</title>
	</head>
	<body>
		<script src="./libs/jquery-1.10.2.min.js"></script>
		<script>
			//TODO: validation. (characters like " aren't validated and may cause XSS vulnerabilities)
			$(document).ready(function() {
				// Hide UI for logged in members (on load)
				$('#loggedInDiv').hide();
				$('#memberUI').hide();

				// Test query button (check spk server status)
				$('#testQuery').on('click', function() {
					$.getJSON(serverIP() + '/status')
						.done(function() { alert('Server up and running.'); })
						.fail(function() { alert('Error, unable to contact server.'); });
				});

				// Textbox enter trigger
				// Login
				$('#username').keyup(function(event){
				    if(event.keyCode == 13){
					$('#loginButton').click();
				    }
				});
				// Subscribe
				$('#subscriptionTarget').keyup(function(event){
				    if(event.keyCode == 13){
					$('#subscribeButton').click();
				    }
				});
				// Post
				$('#messageContent').keyup(function(event){
				    if(event.keyCode == 13){
					$('#postButton').click();
				    }
				});

				// Display name form ajax query (register/signup)
				$('#loginButton').on('click', function() {
					//First, we query to check if the username exists
					$.getJSON(serverIP() + '/members/' + $('#username').val())
						.done(function(data) { 
							//case: user exist, login
							successfulLogin(data)
						 })
						.fail(function() {
							//case: user does not exist, register
							$.ajax({
								dataType: 'json',
								url: serverIP() + '/members',
								contentType: "application/json",
								type:'POST',
								data: '{"username":"' + $('#username').val() + '", "display_name":"' + $('#username').val() + '"}'

							})
							.done(function(data) { successfulLogin(data) })
							.fail(function() { alert('Error, unable to register new member.');
						});
					});
				});
				// Add new subscription
				$('#subscribeButton').on('click', function() {
					var subscription_target = $('#subscriptionTarget').val();
					// First, we check if the specified member is already a subscriber
					if(isAlreadySubscribedTo(subscription_target)) {
						alert('You are already subscribed to the specified member.');
					} else {
						// Second, we query to check if the username exists
						$.getJSON(serverIP() + '/members/' + subscription_target)
							.done(function(data) {
								// case: user exist, create new subscription
								var subscription_display_name = data["display_name"];
								$.ajax({
									dataType: 'json',
									url: serverIP() + '/members/' + $('#usernameKey').val() + '/subscriptions/',
									contentType: "application/json",
									type:'POST',
									data: '{"subscription_username":"' + subscription_target + '", "subscription_display_name":"' + subscription_display_name + '"}'
								})
								.done(function(data) {
									reloadSubscriptions();
									$('#subscriptionTarget').val('');
								})
								.fail(function() { alert('Error, unable to register new member.'); });
							 })
							.fail(function() {
								// case: user does not exist, warn user
								alert('Specified user not found.')
							});
					}
				});
				// Post new message
				$('#postButton').on('click', function() {
					var message_content = $('#messageContent').val();
					// Check if the message is not empty
					if(!isEmpty(message_content)) {
						// Post the message and refresh feed!
						$.ajax({
							dataType: 'json',
							url: serverIP() + '/members/' + $('#usernameKey').val() + '/messages/',
							contentType: "application/json",
							type:'POST',
							data: '{"username":"' + $('#usernameKey').val() +
								'", "message_content":"' + message_content +
								'", "message_display_name":"' + $('#usernameKey').val() + '"}'//TODO: use the display name from the local display name form
						})
						.done(function(data) {
							$('#messageContent').val('');
						})
						.fail(function() { alert('Error, unable to post new message.'); });
					}
				});
				

			});
			// Login ui display helper
			function successfulLogin(data) {
				var display_name = data["display_name"];
				var username = data["username"];
				$('#displayNameWelcome').text(display_name);
				$('#loginDiv').hide();
				$('#loggedInDiv').show();
				$('#usernameKey').val(username);
				$('#memberUI').show();
				reloadSubscriptions()
				//Periodic refresh feed call
				refreshFeed();
			}
			// Subscription refresh helpers, all subs are stored locally in member_subscriptions
			var member_subscriptions;
			function reloadSubscriptions() {
				// GET all subscriptions for the logged in member
				$.getJSON(serverIP() + '/members/' + $('#usernameKey').val() + '/subscriptions/')
					.done(function(data) {
						member_subscriptions = data;
						displaySubscriptions();
					});
			}
			// Display subscriptions
			function displaySubscriptions() {
				var subscriptions_content = "";
				if(member_subscriptions.length > 0) {
					$.each(member_subscriptions, function(i, subscription)  {
						var subscription_id = subscription["subscription_id"];
						var subscription_username = subscription["username"];
						var subscription_username_id = subscription["subscription_username"];
						subscriptions_content += '<li id="' + subscription_username + '">' + subscription_username_id + '</li>';
					});
				} else {
					subscriptions_content = "<li>You don't have any friends yet!</li>"
				}
				$('#subscription_list').html(subscriptions_content);
			}
			// Display susbscriptions
			function isAlreadySubscribedTo(subscriptionUsername) {
				for(var i=0;i<member_subscriptions.length;i++)
					if(member_subscriptions[i].subscription_username == subscriptionUsername)
						return true;
				return false;
			}
			// Empty string validation helper
			function isEmpty(str) {
				return (!str || 0 === str.length);
			}
			// Get server IP helper
			function serverIP(){
				return $('#serverAddress').val();
			}
			// JSon object sorter helper
			function sortResults(data, prop, asc) {
			    data = data.sort(function(a, b) {
				if (asc) return (a[prop] > b[prop]) ? 1 : ((a[prop] < b[prop]) ? -1 : 0);
				else return (b[prop] > a[prop]) ? 1 : ((b[prop] < a[prop]) ? -1 : 0);
			    });
			}			
			// Feed refresh helper
			function refreshFeed() {
				// Ajax feed refresh call only if the user is logged
				if(!isEmpty($('#usernameKey').val())) {
					setTimeout(refreshFeed,1000);
					$.getJSON(serverIP() + '/members/' + $('#usernameKey').val() + '/feeds/')
						.done(function(feed) {
							sortResults(feed, 'feed_id', false)
							var feed_content = "";
							$.each(feed, function(i, feedEntry)  {
								var subscription_display_name = feedEntry["subscription_display_name"];
								var message_content = feedEntry["message_content"];
								feed_content += '<span style="text-decoration:underline">' + subscription_display_name + ' posted: </span>' +
									'<br />' + message_content + '<br />';
							});
							$('#feedContent').html(feed_content);
						})
						.fail(function() {
							//fail silently
						});
				}
			}
		</script>
		<div style="width:900px; margin:0 auto; border:3px solid black; padding:1em 1em 3em 1em">
			<div style="text-align:right"><button type="button" id="testQuery">Check Spk Server Status</button></div>
			<table style="width:100%">
				<tr>
					<td><h1>Spk social platform</h1></td>
				</tr>	
				<tr>
					<td>
						<div id="loginDiv">
							<h6 style="padding-left:6em">Login/Register</h6>
							Username: <br />
							<input type="text" name="username" id="username" />
							<br />
							<button type="button" id="loginButton">ok!</button>
						</div>
						<div id="loggedInDiv">
							Welcome <span style="text-decoration:underline"id="displayNameWelcome"></span><span>!</span>
							<input type="hidden" name="usernameKey" id="usernameKey"/>
						</div>
					</td>
				</tr>
				<tr>
					<td><div id="memberUI">
						<div style="float:left;width:30%;">
							<h4>Your subscriptions</h4>
							<div style="width:95%;border:2px solid black;paddin:2em 1em 2em 1em">
								<ul id="subscription_list" style="padding-right:1em"></ul>
							</div>
							<br />
							Subscribe to someone!
							<br />
							<input type="text" name="subscriptionTarget" id="subscriptionTarget" style="width:50%" />
							<br />
							<button type="button" id="subscribeButton">subscribe!</button>
						</div>
						<div style="float:right;width:70%;">
							<h4>Your Feed</h4>
							<br />
							<input type="text" name="messageContent" id="messageContent" style="width:99%" />
							<br />
							<button type="button" id="postButton" style="float:right">post!</button>
							<br />
							<br />
							<div style="width:99%;border:2px solid black;" id="feedContent"> </div>
						</div>
					</div></td>
				</tr>
			</table>
		</div>
			<div style="text-align:center;padding-top:1em"><h6>server address: <input type="text" id="serverAddress" value="http://172.22.2.28:9999"></h6></div>
	</body>
</html>
